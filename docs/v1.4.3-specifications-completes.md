# V.1.4.3 - Sp√©cifications Compl√®tes

**Date** : 2025-01-XX  
**Statut** : Sp√©cifications valid√©es - Pr√™t pour cr√©ation des epics/stories  
**Branche** : `v1.4.3` (√† cr√©er)

---

## üìã Besoins Identifi√©s

### 1. Paiements Multiples √† l'Encaissement ‚úÖ
**Besoin** : Permettre plusieurs moyens de paiement (ex. esp√®ces + ch√®ques) lors d'un m√™me encaissement.

**D√©cisions** :
- ‚úÖ Approche s√©quentielle (ajouter paiements un par un)
- ‚úÖ Pas de limite de nombre de paiements (d√©pend des modes de paiement disponibles)
- ‚úÖ Modes de paiement actuels : esp√®ces, ch√®que, carte (peut-√™tre virement plus tard)

**Recherche POS** : Les syst√®mes POS modernes supportent les split payments. Pattern s√©quentiel recommand√©.

---

### 2. √âdition du Poids Apr√®s Validation ‚úÖ
**Besoin** : Modifier le poids a posteriori dans les sessions de vente et r√©ception, avec mise √† jour des statistiques.

**D√©cisions** :
- ‚úÖ **Qui peut modifier** : Administrateur uniquement
- ‚úÖ **Limite de temps** : Aucune limite
- ‚úÖ **Alerte** : Pas d'alerte si modification importante

**Impact technique** : Recalcul n√©cessaire des statistiques (poids ventes, poids r√©ception, statistiques live, m√©triques mensuelles).

---

### 3. Bug : Date des Tickets ‚úÖ
**Probl√®me** : Tous les tickets ont la date d'ouverture de session au lieu de la date d'enregistrement.

**Contexte** : Li√© √† la logique de session diff√©r√©e. Les sessions diff√©r√©es permettent de saisir des tickets d'un jour donn√© mais enregistr√©s plus tard (ex. saisie manuelle apr√®s panne informatique, presque un mois de donn√©es √† re-saisir).

**Besoin exprim√©** : 
- Garder la date d'enregistrement (quand le ticket a √©t√© saisi dans le syst√®me)
- Afficher la date r√©elle du ticket (date du cahier/journal papier)
- Pr√©f√©rence : sans changer la base de donn√©es si possible, mais ouvert √† des changements si n√©cessaire

**D√©cision** : ‚úÖ **Option 1 valid√©e** - Ajouter un champ `sale_date` sur `Sale` avec migration
- `sale_date` = date r√©elle du ticket (opened_at de session si diff√©r√©e, sinon created_at)
- `created_at` = toujours la date d'enregistrement (NOW())
- N√©cessite une migration de base de donn√©es

**Investigation n√©cessaire** : Analyse approfondie du code de session diff√©r√©e et de la logique de date avant impl√©mentation.

---

### 4. √âditeur d'Item - Destination ‚úÖ
**Besoin** : S'assurer que l'√©dition de la destination est disponible et √©ditable dans l'√©diteur d'item des tickets de vente.

**Clarification** : 
- ‚úÖ Uniquement pour les **ventes** (cash sessions)
- ‚úÖ Pas pour les r√©ceptions (fonctionne d√©j√†, utilise un autre √©diteur)
- ‚úÖ Les destinations sont g√©r√©es via les **presets** (boutons pr√©d√©finis) :
  - Don 0‚Ç¨
  - Don -18 ans
  - Recyclage
  - D√©ch√®terie

**√âtat actuel (post B52-P4)** : 
- Le mod√®le `SaleItem` a un champ `preset_id` qui r√©f√©rence les presets (Don 0‚Ç¨, Don -18 ans, Recyclage, D√©ch√®terie)
- L'√©diteur d'item affiche une section **¬´ Type de transaction (optionnel) ¬ª** avec :
  - les boutons des presets disponibles (ou un fallback Don 0‚Ç¨ / Don -18 ans / Recyclage / D√©ch√®terie si l'API presets ne r√©pond pas),
  - un bouton **¬´ ‚úï Aucun ¬ª** pour retirer la destination.
- Lors de l'√©dition d'un item :
  - L'utilisateur peut **modifier la destination** en s√©lectionnant un autre preset,
  - Il peut √©galement **retirer la destination** via le bouton ¬´ Aucun ¬ª,
  - La s√©lection ou suppression du preset est **persist√©e** dans l'item (champ `preset_id` mis √† jour ou remis √† `null`),
  - La destination affich√©e dans le ticket refl√®te toujours l'√©tat r√©el de l'item.

**Action** : ‚úÖ **B52-P4 impl√©ment√©e** ‚Äì l'√©dition et la suppression de la destination via l'√©diteur d'item sont fonctionnelles et test√©es.

---

### 5. √âdition du Prix ‚úÖ
**Besoin** : Permettre l'√©dition du prix dans l'√©diteur d'item.

**D√©cisions** :
- ‚úÖ **Qui peut modifier** : Administrateur uniquement
- ‚úÖ **R√©glementation** : Log d'audit complet (ancien prix, nouveau prix, utilisateur, timestamp)
- ‚úÖ **Confirmation** : Pas de confirmation suppl√©mentaire (le fait d'√™tre admin suffit)

**Recherche r√©glementation** : 
- Non-assujettis TVA = obligations r√©duites mais tra√ßabilit√© recommand√©e
- Pratique courante : validation manager pour modification de prix
- **Paheko** : Logiciel de gestion d'association, pas de documentation sp√©cifique sur modification de prix trouv√©e. Probablement pas la solution backend utilis√©e.

---

## üîç Investigation Bug Date des Tickets

### Analyse du Code Actuel

**Fichier** : `api/src/recyclic_api/api/api_v1/endpoints/sales.py` (lignes 144-175)

**Logique actuelle** :
```python
# Story B51-P2: Une session est diff√©r√©e si opened_at est √† plus de 2 minutes dans le pass√©
time_diff = (now - session_opened_at).total_seconds()
if time_diff > 120:  # Plus de 2 minutes dans le pass√© = session diff√©r√©e
    sale_created_at = session_opened_at  # Utilise opened_at de la session
```

**Probl√®me identifi√©** :
- Pour les sessions diff√©r√©es, `created_at` de la vente est √©cras√© par `opened_at` de la session
- Cela fait perdre la date d'enregistrement r√©elle (quand le ticket a √©t√© saisi)
- Le frontend affiche `created_at` comme date du ticket (CashSessionDetail.tsx ligne 844)

### Propositions de Solution

#### Option 1 : Ajouter un champ `sale_date` sur Sale (RECOMMAND√âE)
**Avantages** :
- ‚úÖ Explicite et clair : `sale_date` = date r√©elle du ticket, `created_at` = date d'enregistrement
- ‚úÖ Pas de confusion entre les deux dates
- ‚úÖ Permet de garder la tra√ßabilit√© compl√®te

**Inconv√©nients** :
- ‚ö†Ô∏è N√©cessite une migration de base de donn√©es
- ‚ö†Ô∏è Modification du mod√®le Sale

**Impl√©mentation** :
```python
# Mod√®le Sale
sale_date = Column(DateTime(timezone=True), nullable=True)  # Date r√©elle du ticket (opened_at de session si diff√©r√©e, sinon created_at)
created_at = Column(DateTime(timezone=True), server_default=func.now())  # Toujours la date d'enregistrement
```

**Logique** :
- Pour sessions normales : `sale_date = created_at` (m√™me valeur)
- Pour sessions diff√©r√©es : `sale_date = opened_at` (date du cahier), `created_at = NOW()` (date de saisie)

#### Option 2 : Utiliser `opened_at` de la session comme r√©f√©rence
**Avantages** :
- ‚úÖ Pas de modification de base de donn√©es
- ‚úÖ Utilise les donn√©es existantes

**Inconv√©nients** :
- ‚ö†Ô∏è N√©cessite de joindre `CashSession` √† chaque requ√™te pour obtenir la date r√©elle
- ‚ö†Ô∏è Moins explicite dans le mod√®le

**Impl√©mentation** :
- Toujours utiliser `created_at = NOW()` (m√™me pour sessions diff√©r√©es)
- Pour afficher la date r√©elle : utiliser `cash_session.opened_at` si session diff√©r√©e
- Ajouter un champ calcul√© `sale_date` dans le sch√©ma de r√©ponse API

#### Option 3 : Utiliser `updated_at` pour la date d'enregistrement
**Avantages** :
- ‚úÖ Pas de modification de base de donn√©es

**Inconv√©nients** :
- ‚ùå `updated_at` change √† chaque modification (pas fiable pour date d'enregistrement)
- ‚ùå Pas adapt√© au besoin

### Recommandation

**Option 1** est la meilleure solution car :
1. Explicite et claire : deux champs distincts pour deux dates distinctes
2. Tra√ßabilit√© compl√®te : on garde toujours la date d'enregistrement ET la date r√©elle
3. √âvolutive : permet d'ajouter d'autres m√©tadonn√©es de date si n√©cessaire

**Migration n√©cessaire** :
- Ajouter colonne `sale_date` √† la table `sales`
- Remplir `sale_date` avec `created_at` pour les ventes existantes
- Pour les nouvelles ventes : `sale_date = opened_at` si session diff√©r√©e, sinon `sale_date = created_at`

---

## üìä Points Cosm√©tiques/Terminologie

**Statut** : √Ä traiter plus tard, apr√®s les fonctionnalit√©s principales.

---

## ‚úÖ Validation des D√©cisions

### 1. Paiements Multiples
- ‚úÖ Approche s√©quentielle
- ‚úÖ Pas de limite de nombre
- ‚úÖ Modes de paiement : esp√®ces, ch√®que, carte (virement plus tard)

### 2. √âdition du Poids
- ‚úÖ Administrateur uniquement
- ‚úÖ Pas de limite de temps
- ‚úÖ Pas d'alerte

### 3. Bug Date des Tickets
- ‚úÖ Option 1 valid√©e (champ `sale_date` avec migration)
- ‚úÖ Investigation approfondie n√©cessaire avant impl√©mentation

### 4. Destination dans √âditeur
- ‚úÖ Uniquement pour les ventes (cash sessions)
- ‚úÖ Les destinations sont les presets (Don 0‚Ç¨, Don -18 ans, Recyclage, D√©ch√®terie)
- ‚úÖ L'√©diteur permet d√©j√† de modifier le preset
- ‚è≥ Audit n√©cessaire pour v√©rifier que l'√©dition fonctionne correctement

### 5. √âdition du Prix
- ‚úÖ Administrateur uniquement
- ‚úÖ Log d'audit complet

---

## üéØ Prochaines √âtapes

1. ‚úÖ Recherches compl√©t√©es
2. ‚úÖ Audit technique compl√©t√©
3. ‚úÖ Sp√©cifications document√©es
4. ‚úÖ Validation des propositions pour le bug de date (Option 1)
5. ‚úÖ **Branche `v1.4.3` cr√©√©e**
6. ‚è≥ **Cr√©ation des epics/stories**
7. ‚è≥ Planification de d√©veloppement

---

## üìù Notes Techniques

### Paheko
- Logiciel de gestion d'association
- Module caisse disponible mais pas de documentation sp√©cifique sur modification de prix
- Probablement pas la solution backend utilis√©e par Recyclic

### R√©glementation
- Non-assujettis TVA = obligations r√©duites
- Tra√ßabilit√© recommand√©e pour la comptabilit√©
- Log d'audit suffisant pour les modifications de prix

### Performance
- Recalcul des statistiques apr√®s modification de poids = point d'attention
- Optimiser le recalcul (uniquement les statistiques affect√©es)

