# V.1.4.3 - Recherches et Discussion Pr√©alable

**Date** : 2025-01-XX  
**Statut** : Discussion pr√©alable avant cr√©ation des epics/stories

---

## üìã R√©sum√© des Besoins

### 1. Paiements Multiples √† l'Encaissement
**Besoin** : Permettre plusieurs moyens de paiement (ex. esp√®ces + ch√®ques) lors d'un m√™me encaissement.

### 2. √âdition du Poids Apr√®s Validation
**Besoin** : Modifier le poids a posteriori dans les sessions de vente et r√©ception, avec mise √† jour des statistiques.

### 3. Bug : Date des Tickets
**Probl√®me** : Tous les tickets ont la date d'ouverture de session au lieu de la date d'enregistrement.

### 4. √âditeur d'Item - Champs Manquants
**Besoin** : Ajouter l'√©dition de la destination et audit complet de l'√©diteur.

### 5. Points Cosm√©tiques/Terminologie
**Besoin** : √Ä traiter plus tard.

---

## üîç Recherches Effectu√©es

### 1. Paiements Multiples - POS Classiques

**R√©sultats de recherche** :
- Les syst√®mes POS modernes supportent les **split payments** (paiements divis√©s)
- Fonctionnalit√© standard : diviser le total entre plusieurs moyens de paiement
- Exemples courants :
  - Esp√®ces + Carte bancaire
  - Esp√®ces + Ch√®que
  - Plusieurs cartes diff√©rentes
  - Carte + Points de fid√©lit√©

**Patterns UX identifi√©s** :
1. **Approche s√©quentielle** : 
   - Saisir le premier paiement (ex. esp√®ces)
   - Afficher le reste d√ª
   - Bouton "Ajouter un autre paiement"
   - R√©p√©ter jusqu'√† couvrir le total

2. **Approche simultan√©e** :
   - Interface avec plusieurs champs de paiement
   - Validation globale une fois le total couvert

**Recommandation** : Approche s√©quentielle plus intuitive pour notre cas d'usage.

**R√©f√©rences** :
- eHopper POS : Split payments par montant, item, ou invit√©
- Commerce7 : Division du total en diff√©rents tenders
- Acid POS : Traitement simultan√© de tous les paiements

---

### 2. R√©glementation - Modification de Prix

**R√©sultats de recherche** :

#### R√©glementation Fran√ßaise (BOI-TVA-DECLA-30-10-30)
- **Inalt√©rabilit√©** : Les donn√©es de r√®glement doivent √™tre enregistr√©es sans possibilit√© d'alt√©ration
- **S√©curisation** : Les modifications doivent √™tre s√©curis√©es et trac√©es
- **Tra√ßabilit√©** : Les modifications ne remplacent pas les donn√©es initiales, elles cr√©ent un nouvel enregistrement

#### Cas Particulier : Non-Assujettis TVA
- Les non-assujettis √† la TVA ont des obligations r√©duites
- N√©anmoins, la tra√ßabilit√© reste importante pour la comptabilit√©
- Pas d'obligation de certification NF525 pour les non-assujettis

#### Pratiques Courantes
- **Supermarkets** : Modification de prix n√©cessite validation manager (badge sp√©cial)
- **Tickets provisoires** : Modifiables avant paiement, d√©finitifs apr√®s
- **Audit trail** : Toutes modifications doivent √™tre trac√©es

**Recommandation pour Recyclic** :
- Permettre modification de prix avec **confirmation administrateur**
- Logger toutes les modifications dans l'audit trail
- Conserver l'historique (ancien prix + nouveau prix)
- Option : Badge/confirmation pour les utilisateurs non-admin

**Note Paheco** : Recherche sp√©cifique Paheco non concluante (documentation API limit√©e en ligne). √Ä v√©rifier directement avec Paheco si int√©gration pr√©vue.

---

### 3. Bug Date des Tickets - Audit Technique

**Code analys√©** : `api/src/recyclic_api/api/api_v1/endpoints/sales.py` (lignes 144-175)

**Probl√®me identifi√©** :
```python
# Story B51-P2: Une session est diff√©r√©e si opened_at est √† plus de 2 minutes dans le pass√©
time_diff = (now - session_opened_at).total_seconds()
if time_diff > 120:  # Plus de 2 minutes dans le pass√© = session diff√©r√©e
    sale_created_at = session_opened_at
```

**Analyse** :
- Le code utilise `opened_at` de la session uniquement si la session est "diff√©r√©e" (> 2 min dans le pass√©)
- Pour les sessions normales, `created_at` devrait utiliser `NOW()` (comportement par d√©faut)
- **Hypoth√®se** : Le bug pourrait venir d'un probl√®me de timezone ou d'une condition qui se d√©clenche incorrectement

**Points √† v√©rifier** :
1. Les sessions normales ont-elles un `opened_at` correct ?
2. Y a-t-il un probl√®me de timezone dans la comparaison ?
3. Le seuil de 2 minutes est-il appropri√© ?

**Action recommand√©e** : 
- V√©rifier les logs de cr√©ation de ventes
- Tester avec une session normale r√©cente
- V√©rifier que `created_at` utilise bien `NOW()` par d√©faut

---

### 4. √âditeur d'Item - Audit Complet

**Code analys√©** : `frontend/src/components/business/Ticket.tsx` (lignes 334-639)

**Champs actuellement √©ditables** :
- ‚úÖ Cat√©gorie (lecture seule)
- ‚úÖ Quantit√©
- ‚úÖ Poids (kg)
- ‚úÖ Prix unitaire
- ‚úÖ Type de transaction (preset)
- ‚úÖ Notes

**Champs manquants** :
- ‚ùå **Destination** (MAGASIN, RECYCLAGE, DECHETERIE)

**Analyse technique** :
- Le mod√®le `SaleItem` (backend) **n'a pas de champ `destination`**
- Le mod√®le `LigneDepot` (r√©ception) a un champ `destination` (enum)
- Les ventes n'ont pas de destination car elles sont toujours des sorties (ventes)

**Question importante** : 
- La destination est-elle pertinente pour les **ventes** (cash sessions) ?
- Ou est-ce uniquement pour les **r√©ceptions** (reception sessions) ?

**Recommandation** :
- Clarifier avec l'utilisateur si la destination doit √™tre ajout√©e aux ventes
- Si oui, ajouter le champ `destination` au mod√®le `SaleItem`
- Si non, l'√©diteur d'item pour ventes est complet (sauf destination qui n'est pas applicable)

---

### 5. √âdition du Poids - Impact sur Statistiques

**Code analys√©** :
- `api/src/recyclic_api/services/cash_session_service.py` (lignes 661-688)
- `api/src/recyclic_api/services/reception_stats_service.py` (lignes 243-261)

**Calculs de poids identifi√©s** :

#### Ventes (Sales)
- `poids_ventes` = `SUM(SaleItem.weight)` avec filtres de date
- Utilis√© dans `get_session_stats()` et `_calculate_weight_out()`

#### R√©ception
- `poids_total` = `SUM(LigneDepot.poids_kg)` (tous les tickets)
- `poids_entree` = `SUM(LigneDepot.poids_kg)` o√π `is_exit=false` ET `destination=MAGASIN`
- `poids_direct` = `SUM(LigneDepot.poids_kg)` o√π `is_exit=false` ET `destination IN (RECYCLAGE, DECHETERIE)`
- `poids_sortie` = `SUM(LigneDepot.poids_kg)` o√π `is_exit=true`

#### Statistiques Live
- `weight_in` : Poids entr√© en boutique (r√©ception)
- `weight_out` : Poids vendu (ventes) + poids sorties (r√©ception avec `is_exit=true`)

**Impact d'une modification de poids** :
1. ‚úÖ Mise √† jour directe dans la table (`SaleItem.weight` ou `LigneDepot.poids_kg`)
2. ‚ö†Ô∏è **Recalcul n√©cessaire** des statistiques agr√©g√©es :
   - Totaux de session
   - Statistiques live (24h)
   - Statistiques mensuelles
   - M√©triques de r√©ception

**Recommandation** :
- Cr√©er un service de recalcul des statistiques apr√®s modification de poids
- Option 1 : Recalcul √† la vol√©e (lent mais pr√©cis)
- Option 2 : Cache invalid√© + recalcul asynchrone
- Option 3 : Recalcul uniquement des statistiques affect√©es (optimis√©)

**Points √† v√©rifier** :
- Les statistiques sont-elles calcul√©es en live ou mises en cache ?
- Y a-t-il des triggers SQL qui recalculent automatiquement ?
- Les statistiques mensuelles sont-elles pr√©-calcul√©es ou calcul√©es √† la demande ?

---

## üí¨ Points de Discussion

### 1. Paiements Multiples
**Questions** :
- Pr√©f√©rer l'approche s√©quentielle (ajouter paiements un par un) ou simultan√©e (plusieurs champs) ?
- Limite du nombre de paiements multiples ? (ex. max 3-4 moyens)
- Gestion du reste d√ª : afficher en temps r√©el ?
- Validation : tous les paiements doivent couvrir exactement le total ou peut-on avoir un reste ?

**Recommandation** : Approche s√©quentielle avec affichage du reste d√ª.

---

### 2. √âdition du Poids
**Questions** :
- Qui peut modifier le poids ? (Tous les utilisateurs ou seulement admin/manager ?)
- Limite de temps pour modifier ? (ex. uniquement le jour m√™me, ou sans limite ?)
- Notification/alerte si modification importante ? (ex. > 10% de diff√©rence)
- Recalcul automatique ou manuel des statistiques ?

**Recommandation** : 
- Modification autoris√©e pour tous, avec log d'audit
- Recalcul automatique des statistiques affect√©es
- Alerte si modification > 20% du poids initial

---

### 3. Bug Date des Tickets
**Questions** :
- Le bug affecte-t-il toutes les sessions ou seulement certaines ?
- Y a-t-il des sessions "diff√©r√©es" qui fonctionnent correctement ?
- Pr√©f√©rence : fix imm√©diat ou investigation approfondie d'abord ?

**Recommandation** : Investigation rapide puis fix cibl√©.

---

### 4. √âditeur d'Item - Destination
**Questions** :
- La destination est-elle pertinente pour les **ventes** (cash sessions) ?
- Ou est-ce uniquement pour les **r√©ceptions** (reception sessions) ?
- Si oui pour les ventes, quelle est la logique m√©tier ? (Tous les items vendus sortent du magasin)

**Recommandation** : Clarifier avec l'utilisateur avant d'ajouter le champ.

---

### 5. √âdition du Prix
**Questions** :
- Confirmation administrateur obligatoire ou optionnelle ?
- Log d'audit suffisant ou besoin d'un workflow d'approbation ?
- Limite de modification ? (ex. max 10% de diff√©rence)
- Notification automatique aux admins en cas de modification ?

**Recommandation** :
- Confirmation administrateur pour les non-admin
- Log d'audit complet (ancien prix, nouveau prix, utilisateur, timestamp)
- Pas de limite de modification (flexibilit√© m√©tier)

---

## üìä Prochaines √âtapes

1. ‚úÖ Recherches compl√©t√©es
2. ‚úÖ Audit technique compl√©t√©
3. üîÑ **Discussion avec utilisateur** (en cours)
4. ‚è≥ Cr√©ation des epics/stories apr√®s validation
5. ‚è≥ Planification de d√©veloppement

---

## üìù Notes Additionnelles

- **Paheco** : Documentation API non trouv√©e en ligne. √Ä contacter directement si int√©gration pr√©vue.
- **R√©glementation** : Non-assujettis TVA = obligations r√©duites mais tra√ßabilit√© recommand√©e.
- **Performance** : Recalcul des statistiques apr√®s modification de poids = point d'attention pour les performances.


